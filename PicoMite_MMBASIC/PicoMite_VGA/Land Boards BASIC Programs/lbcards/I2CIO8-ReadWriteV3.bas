' Test I2CIO-8 card (I2CIO8-ReadWriteV3.bas)
' Read  4 jumpers, write out to 4 LEDs
' Move jumper to see LED move
'
' Address set to H20
' Uses I2C0
' GPIO0-3 = LEDs = OUT
' GPIO4-7 = Jumpers = IN
'
' LAND BOARDS, 2022
'

MCP23008_I2CADR  = &H21
MCP23008_IODIR   = &H00
MCP23008_IPOL    = &H01
MCP23008_GPINTEN = &H02
MCP23008_DEFVAL  = &H03
MCP23008_INTCON  = &H04
MCP23008_IOCON   = &H05
MCP23008_GPPU    = &H06
MCP23008_INTF    = &H07
MCP23008_INTCAP  = &H08
MCP23008_GPIO    = &H09
MCP23008_OLAT    = &H0A

' MCP23008_IOCON_DEF
' BIT 5 - SEQOP = 1 - DISABLE SEQUENTIAL OPERATIONS
' BIT 4 - DISSLW = 1 - DISABLE SLEW RATE
' BIT 2 - ODR = 1 - OPEN DRAIN OUTPUT (EXTERNAL PULL-UP)
' BIT 1 - IPOL = 0 - ACTIVE LOW INTERRUPT OUTPUT
MCP23008_IOCON_DEF = &H3C

Dim BUF(2):'Allocate receive buffer space
Print "Loop Jumpers to LEDs (I2CIO8-02.bas)"
Print "Hit a key to exit"

' Setup MCP23008 registers
SetPin GP0, GP1, I2C:'Uses I2C2 (I2C1 on part)
I2C OPEN 400, 100:'400KHz, 100 mS timeout
I2C WRITE &H20, 0, 2, MCP23008_IODIR, &HF0:'IODIR
I2C WRITE &H20, 0, 2, MCP23008_IPOL, &HF0:'IPOL INVERT INPUTS
I2C WRITE &H20, 0, 2, MCP23008_IOCON, &H3C:'IOCON NO SEQ, INT HIGH

' Do the loop, CTRL-C to exit

LoopBack:
' Read Jumpers
I2C WRITE &H20, 1, 1, &H09:'SET TO READ GPIO
I2C READ &H20, 0, 1, BUF():'DO THE READ
ODat=(BUF(0)And 240 ) / 16:'MASK OFF OUT BITS, SHIFT RIGHT 4 BITS
' Write out to LEDs
I2C WRITE &H20, 0, 2, &H0A, ODat:'OLAT WRITE OUT
If Inkey$ <> "" GoTo Done
GoTo LoopBack
Done: